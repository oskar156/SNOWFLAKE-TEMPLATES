/* IMPORT TEMPLATE

USER INPUT
FIND AND REPLACE

TABLE_NAME: GPPO248926_13_EO_ALL
FILE_PATH: E:\ORDERS TEMP\GPPO248926-13\GPPO248926_13_EO_ALL.csv
FILE_PATH FORWARD SLASHES: E:/ORDERS TEMP/GPPO248926-13/GPPO248926_13_EO_ALL.csv
STAGE_NAME: OKSTAGETEMP

*/

//https://docs.snowflake.com/en/user-guide/data-load-local-file-system-stage
//https://docs.snowflake.com/en/user-guide/data-load-local-file-system-copy
//https://docs.snowflake.com/en/sql-reference/sql/remove
//https://stackoverflow.com/questions/63385423/copy-into-query-on-snowflake-returns-table-does-not-exist-error


--EXECUTE THE PUT STATEMENT FIRST
PUT 'file://E:/ORDERS TEMP/GPPO248926-13/GPPO248926_13_EO_ALL.csv' @~/OKSTAGETEMP/ OVERWRITE = TRUE;

--THEN EXECUTE THIS ONE (IT'LL TAKE 10+ SECONDS)
DECLARE
RES RESULTSET;

BEGIN
LET QUERY := '';
LET COL_NUMBER := 1;
LET NEXT_COLUMN_EXISTS := TRUE;
LET COLUMN_SELECT_QUERY_SECTION := '';
LET CURRENT_COLUMN := '';

WHILE(:NEXT_COLUMN_EXISTS = TRUE) DO

    QUERY := 'SELECT $'||:COL_NUMBER||' FROM @~/OKSTAGETEMP/GPPO248926_13_EO_ALL.csv limit 1;';
    RES := (EXECUTE IMMEDIATE :QUERY);

    LET CUR CURSOR FOR RES;
    OPEN CUR;
    FETCH CUR INTO CURRENT_COLUMN;
    CLOSE CUR;

    IF(:CURRENT_COLUMN IS null) THEN
        NEXT_COLUMN_EXISTS := FALSE;
    ELSE 
        COLUMN_SELECT_QUERY_SECTION := :COLUMN_SELECT_QUERY_SECTION ||'$'||COL_NUMBER||'::VARCHAR AS '||:CURRENT_COLUMN||',';
    END IF;

    COL_NUMBER := :COL_NUMBER + 1;
END WHILE;

COLUMN_SELECT_QUERY_SECTION := LEFT(COLUMN_SELECT_QUERY_SECTION, LEN(COLUMN_SELECT_QUERY_SECTION) - 1);

QUERY := '
    create or replace file format TEMP_FILE_FORMAT
    type = ''CSV''
    field_delimiter = '',''
    skip_header=1;
';
EXECUTE IMMEDIATE :QUERY;

QUERY := '
    create or replace table GPPO248926_13_EO_ALL as 
    select '||COLUMN_SELECT_QUERY_SECTION||'
    FROM @~/OKSTAGETEMP
    (file_format => TEMP_FILE_FORMAT);
';
EXECUTE IMMEDIATE :QUERY;

QUERY := 'REMOVE @~/OKSTAGETEMP/;';
EXECUTE IMMEDIATE :QUERY;

QUERY := 'DROP FILE FORMAT TEMP_FILE_FORMAT;';
EXECUTE IMMEDIATE :QUERY;
END;


--FILE SHOULD BE IMPORTED, CHECK WHAT HAPPENED
SELECT *
FROM GPPO248926_13_EO_ALL;


LIST @~/OKSTAGETEMP/; --SHOULD BE EMPTY NOW

drop table GPPO248926_13_EO_ALL;
